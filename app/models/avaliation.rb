class Avaliation < ApplicationRecord
  belongs_to :user
  scope :last_not_finished, -> { where(finished: false) }


  def self.send_emails(members,avaliation)
    members.each do |member|
      AnswerMailer.send_email_to_member(member,avaliation).deliver
    end
  end

  def self.is_finished                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
    avaliations_not_finished = Avaliation.where(finished: false)
  end

  def self.is_empty 
    all_avaliations = Avaliation.all 
  end

  def self.finished(avaliation_id)
    avaliation = Avaliation.find(avaliation_id)
    avaliation.update(finished: true)
  end

  def self.create_avaliation(avaliation_params,current_user)
    finished = Avaliation.is_finished
    empty = Avaliation.is_empty

    if finished.blank? || empty.blank?
      avaliation = Avaliation.new(avaliation_params)
      avaliation.user_id = current_user.id
      avaliation.save
      avaliation.update(finished: false)
    end
    avaliation
  end

  def self.generate_average(avaliation_id)
    answers = Answer.by_avaliation_id(avaliation_id)
    avaliation = Avaliation.find(avaliation_id)
    average = []
    answers.each do |answer|
      average << answer.average 
    end
    average_avaliation = average.inject(:+)/answers.size
    avaliation.update(average: average_avaliation)
    avaliation
  end
end
